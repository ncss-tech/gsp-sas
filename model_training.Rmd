---
title: "GSP-CONUS"
author: "Stephen Roecker"
date: "8/4/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# Extract geodata

```{r}

library(raster)

# ISRIC CONUS
path <- "D:/geodata/project_data/gsp-sas/1km covariates/ISRIC/CONUS"
lf <- list.files(path)
isric_rs <- stack(file.path(path, lf))
names(isric_rs) <- gsub("_CONUS.tif|.tif", "", lf)
isric_names <- names(isric_rs)


# Other CONUS
path <- "D:/geodata/project_data/gsp-sas/1km covariates/Other"
lf <- list.files(path)
lf <- lf[grepl(".tif$", lf)]
# find matching extents
other_extent <- sapply(file.path(path, lf), function(x) paste(extent(raster(x))))
idx <- names(sort(table(other_extent), decreasing = TRUE)[1])
idx <- which(other_extent == idx)
lf  <- lf[idx]

other_rs <- stack(file.path(path, lf))
names(other_rs) <- gsub(".tif", "", lf)
other_names <- names(other_rs)


# Extract geodata
library(sf)

load(file = "C:/Users/stephen.roecker/Nextcloud/projects/2020_gsp-sas/LDM-compact_20200709.RData")

rs <- stack(isric_rs, other_rs)
data <- extract(rs, as(s_mps_sf, "Spatial"), df = TRUE, sp = TRUE)@data
data <- within(data, {
  pmkind             = as.factor(pmkind)
  pm_lu_uids_v2_mode = as.factor(pm_lu_uids_v2_mode)
  
  })


# Rename KSSL variables
vars <- c("ph_saturated_paste", "electrical_conductivity_satx", "exchangeable_sodium", "sodium_absorption_ratio", "total_estimated_salts_satx")
vars2 <- c("ph", "ec", "esp", "sar", "tss")
for (i in 1:5) {
  x    = paste0(vars[i], ".")
  x2   = paste0(vars2[i], "_")
  idx  = grep(x, names(data))
  names(data)[idx] = gsub(x, x2, names(data[idx]))
}

# save(data, isric_names, other_names, file = "C:/Users/Stephen.Roecker/Nextcloud/projects/2020_gsp-sas/training_data.RData")

```



# Data Splitting

```{r}

load(file = "C:/Users/Stephen.Roecker/Nextcloud/projects/2020_gsp-sas/training_data.RData")

# split dataset into training and testing
vars <- paste0(vars2[1:3], rep(c("_000_030_cm", "_030_100_cm"), 3))
n    <- round(nrow(data) * 0.75)
clhs_idx  <- clhs::clhs(data[vars], size = n)
clhs_pkey <- data[clhs_idx, "pedon_key"]

train <- subset(data, pedon_key %in% clhs_pkey)
test  <- subset(data, ! pedon_key %in% clhs_pkey)

# save(data, train, test, clhs_pkey, file = "C:/Users/Stephen.Roecker/Nextcloud/projects/2020_gsp-sas/training_data.RData")

```



# Feature Selection

```{r}

load(file = "C:/Users/Stephen.Roecker/Nextcloud/projects/2020_gsp-sas/data.RData")


# subset
idx    <- grep("ec_000_030_cm|B02CHE3", names(train))
train2 <- train[c(idx[1], idx[2]:ncol(train))]
train2 <- train2[idx * -1]



# Boruta
test <- Boruta::Boruta(x, y, maxRuns = 35, doTrace = 1)



# recursive feature elimination
set.seed(111)
library(caret)
rfFuncs$fit <- function(x, y, first, last, ...) {
  train(x, y, 
               method = "ranger", quantreg = TRUE, importance = "permutation",
               # trControl = trainControl(method = "none"), 
               tuneGrid = expand.grid(.mtry = round(sqrt(ncol(y))), .splitrule = "variance", .min.node.size = c(5)
)
               )
}

ctrl.RFE <- rfeControl(functions = rfFuncs,
                       method = "cv",
                       number = 5, 
                       verbose = TRUE)

train3 <- na.exclude(train2)
x = train3[, -1]
y = train3[,  1]
rf.RFE <- rfe(x = x,
              y = y,
              sizes = 5:20,
              rfeControl = ctrl.RFE
              )


# Error in rfe.default(x = compcl[, -1], y = compcl$Prop, sizes = subsets,  :  Bad seeds: the seed object should be a list of length 16 with 15 integer vectors of size 175 and the last list element having a single integer 
 


```



# Model Training

```{r}

# no CV
ec_rt <- train(ec_000_030_cm ~ ., data = train2, 
               method = "ranger", quantreg = TRUE, na.action = na.exclude,
               importance = "permutation", 
               trControl = trainControl(method = "none"), 
               tuneGrid = expand.grid(.mtry = round(ncol(train2[-1]) / 3), .splitrule = "variance", .min.node.size = c(5)
)
               )


# CV
ec_rf <- train(ec_000_030_cm ~ ., data = train2, 
               method = "ranger", quantreg = TRUE,
               na.action = na.exclude,
               trControl = trainControl(method = "cv", number = 0, returnResamp = "all", savePredictions = TRUE, search = "random", verboseIter = FALSE)
               )

```



# SSURGO accuracy

```{r}

# SSURGO vs KSSL at 1000-meters
caret::R2(data$ph_000030, data$ph_saturated_paste.000_030_cm, na.rm = TRUE)
caret::R2(data$ec_000030, data$electrical_conductivity_satx.000_030_cm, na.rm = TRUE)

```

