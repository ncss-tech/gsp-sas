---
title: "GSP-CONUS"
author: "Stephen Roecker"
date: "8/4/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# Extract geodata

```{r}

library(raster)

# ISRIC CONUS
path <- "K:/GSP/modeling/covariates/isric/conus"
lf <- list.files(path)
lf <- lf[grepl(".tif$", lf)]
isric_rs <- stack(file.path(path, lf))
names(isric_rs) <- gsub("_CONUS.tif|.tif", "", lf)
isric_vars <- names(isric_rs)
names(isric_rs)

# Other CONUS
path <- "K:/GSP/modeling/covariates/other"
lf <- list.files(path)
lf <- lf[grepl(".tif$", lf)]
# find matching extents
#other_extent <- sapply(file.path(path, lf), function(x) paste(extent(raster(x))))
#idx <- names(sort(table(other_extent), decreasing = TRUE)[1])
#idx <- which(other_extent == idx)
#lf  <- lf[idx]


other_rs <- stack(file.path(path, lf))
names(other_rs) <- gsub(".tif", "", lf)
other_vars <- names(other_rs)
names(other_rs)

# SSURGO CONUS
path <- "K:/GSP/modeling/covariates/ssurgo"
lf <- list.files(path)
lf <- lf[grepl(".tif$", lf)]
# find matching extents
#other_extent <- sapply(file.path(path, lf), function(x) paste(extent(raster(x))))
#idx <- names(sort(table(other_extent), decreasing = TRUE)[1])
#idx <- which(other_extent == idx)
#lf  <- lf[idx]

ssurgo_rs <- stack(file.path(path, lf))
names(ssurgo_rs) <- gsub(".tif", "", lf)
ssurgo_vars <- names(ssurgo_rs)
names(ssurgo_rs)


# Extract geodata
library(sf)

load(file = "K:/GSP/modeling/LDM-compact_20200709.RData")

rs   <- stack(isric_rs, other_rs, ssurgo_rs)
data <- extract(rs, as(s_mps_sf, "Spatial"), df = TRUE, sp = TRUE)@data
data <- within(data, {
  ssurgo_pm_lu3_rs_mode[is.na(ssurgo_pm_lu3_rs_mode)] = "missing"
  ssurgo_pm_lu3_rs_mode     = as.factor(ssurgo_pm_lu3_rs_mode)
  mlra_rs[is.na(mlra_rs)] = "missing"
  mlra_rs            = as.factor(mlra_rs)
  nlcd_2016_conus[is.na(nlcd_2016_conus)] = "missing"
  nlcd_2016_conus          = as.factor(nlcd_2016_conus)
  })

save(data, isric_vars, other_vars, ssurgo_vars, file = "K:/GSP/modeling/predict/training_data1.RData", overwrite = T)

```



# Data Splitting

```{r}

load(file = "K:/GSP/modeling/predict/training_data1.RData")

# split dataset into training and testing
vars <- names(data)[grepl("ph_ptf.|ec_ptf.|esp.", names(data))]
vars <- vars[grepl("030", vars)]
n    <- round(nrow(data) * 0.75)
set.seed(111)
clhs_idx  <- clhs::clhs(data[vars], size = n)
clhs_pkey <- data[clhs_idx, "pedon_key"]

train <- subset(data, pedon_key %in% clhs_pkey)
test  <- subset(data, ! pedon_key %in% clhs_pkey)

save(data, train, test, clhs_pkey, isric_vars, other_vars, ssurgo_vars, file = "K:/GSP/modeling/predict/training_data.RData", overwrite = T)

```



# Feature Selection

```{r}

load(file = "K:/GSP/modeling/predict/training_data.RData")

# high correlations; this analysis wasn't particularly useful
library(caret)

#vars <- c(isric_vars, other_vars)
#data2 <- data[vars]
#idx <- sapply(data2, is.numeric)

#vars_0 <- nearZeroVar(data2[idx], names = TRUE)

#vars_cor <- findCorrelation(na.exclude(data2), names = TRUE) 


# subset
sp_vars <- names(data)[grepl("ec_ptf.0|esp.0", names(data))]


# Boruta
library(Boruta)
fs_b <- lapply(sp_vars, function(x) {
  cat(x, as.character(Sys.time()), "\n")
  train2 <- data[c(x, 
                   c(ssurgo_vars),
                   isric_vars, 
                   other_vars 
                   )]
  train2 <- na.exclude(train2)
  names(train2) <- gsub("\\.", "_", names(train2))
  test <- Boruta::Boruta(x = train2[-1], y = log(train2[[1]]+0.1), maxRuns = 35, doTrace = 1)
})
names(fs_b) <- sp_vars

save(fs_b, file = "K:/GSP/modeling/predict/fs_boruta_ec_esp.RData", overwrite = T)
load(file = "K:/GSP/modeling/predict/fs_boruta_ec_esp.RData")

#view objective function
plot(fs_b$ec_ptf.000_030_cm) #approx 15 covs
plot(fs_b$ec_ptf.030_100_cm) #approx 18 covs

#create, view, export importance stats
cov_ec0 <- attStats(fs_b$ec_ptf.000_030_cm)
cov_ec0_c <- subset(cov_ec0, decision == "Confirmed")
cov_ec30 <- attStats(fs_b$ec_ptf.030_100_cm)
cov_ec30_c <- subset(cov_ec30, decision == "Confirmed")
write.csv(cov_ec0_c, file = "K:/GSP/modeling/predict/ec_0_boruta.csv")
write.csv(cov_ec30_c, file = "K:/GSP/modeling/predict/ec_30_boruta.csv")

#stephen's method to filter stats for confirmed variables
fs_b_stats <- lapply(fs_b, function(x) {
  s <- Boruta::attStats(x)
  s <- data.frame(variable = row.names(s), varImp = s$medianImp, decision = s$decision,  stringsAsFactors = FALSE)
  s$variable <- reorder(as.factor(s$variable), s$varImp, sum)
  s <- s[order(- s$varImp), ]
  row.names(s) <- 1:nrow(s)
  return(s)
  })

library(ggplot2)
ggplot(fs_b_stats$ec_ptf.000_030_cm, aes(x = varImp, y = variable)) +
  geom_point()
ggplot(fs_b_stats$ec_ptf.030_100_cm, aes(x = varImp, y = variable)) +
  geom_point()



```



# Model Training

```{r}

library(caret)
library(ranger)

load(file = "K:/GSP/modeling/predict/training_data.RData")

##0-30cm##
#filter training data 
vars <- c("ec_ptf.000_030_cm",
          isric_vars, 
          other_vars,
          # remove matching ssurgo derivative
          ssurgo_vars[!grepl("ssurgo_ptec", ssurgo_vars)]
          )
train2 <- na.exclude(train[vars])

#for all confirmed 
#cov_list <- setNames(split(cov_ec0_c, seq(nrow(cov_ec0_c))), rownames(cov_ec0_c))
#names(cov_list)
#cov_list <- as.list(cov_list)
#vars <- c("ec_ptf.000_030_cm", names(cov_list)[! grepl("ssurgo_pte", names(cov_list))])
#train2 <- na.exclude(train[vars])

#(1) all confirmed variables
idx <- which(names(train2) %in% fs_b_stats$ec_ptf.000_030_cm$variable[fs_b_stats$ec_ptf.000_030_cm$decision == "Confirmed"])
#test model; no cv
ec0_rf_all <- ranger(y = log(train2$ec_ptf.000_030_cm +0.1), x = train2[idx], 
                    quantreg = TRUE, importance = "permutation",
                    respect.unordered.factors = FALSE,
                    seed = 111 
                    )

r2_ec0_all <- ec0_rf_all$r.squared

#(2) half of confirmed variables
fs_b_stats$ec_ptf.000_030_cm #to look at variables in ranked order
idx <- which(names(train2) %in% fs_b_stats$ec_ptf.000_030_cm$variable[3:46])
#test model; no cv
ec0_rf_half <- ranger(y = log(train2$ec_ptf.000_030_cm +0.1), x = train2[idx], 
                    quantreg = TRUE, importance = "permutation",
                    respect.unordered.factors = FALSE,
                    seed = 111 
                    )

r2_ec0_half <- ec0_rf_half$r.squared

#(3) variables based on boruta plot (17 for 0-30)
idx <- which(names(train2) %in% fs_b_stats$ec_ptf.000_030_cm$variable[3:17])
#test model; no cv
ec0_rf_top <- ranger(y = log(train2$ec_ptf.000_030_cm +0.1), x = train2[idx], 
                    quantreg = TRUE, importance = "permutation",
                    respect.unordered.factors = FALSE,
                    seed = 111 
                    )

r2_ec0_top <- ec0_rf_top$r.squared

##30-100cm##
#filter training data 
vars <- c("ec_ptf.030_100_cm",
          isric_vars, 
          other_vars,
          # remove matching ssurgo derivative
          ssurgo_vars[!grepl("ssurgo_ptec", ssurgo_vars)]
          )
train2 <- na.exclude(train[vars])

#(1) all confirmed variables
idx <- which(names(train2) %in% fs_b_stats$ec_ptf.030_100_cm$variable[fs_b_stats$ec_ptf.030_100_cm$decision == "Confirmed"])
#test model; no cv
ec30_rf_all <- ranger(y = log(train2$ec_ptf.030_100_cm +0.1), x = train2[idx], 
                    quantreg = TRUE, importance = "permutation",
                    respect.unordered.factors = FALSE,
                    seed = 111 
                    )

r2_ec30_all <- ec30_rf_all$r.squared

#(2) half of confirmed variables
fs_b_stats$ec_ptf.030_100_cm #to look at variables in ranked order
idx <- which(names(train2) %in% fs_b_stats$ec_ptf.030_100_cm$variable[2:46])#has ec0-30
#test model; no cv
ec30_rf_half <- ranger(y = log(train2$ec_ptf.030_100_cm +0.1), x = train2[idx], 
                    quantreg = TRUE, importance = "permutation",
                    respect.unordered.factors = FALSE,
                    seed = 111 
                    )

r2_ec30_half <- ec30_rf_half$r.squared

#(3) variables based on boruta plot (19 for 30-100)
idx <- which(names(train2) %in% fs_b_stats$ec_ptf.030_100_cm$variable[2:18])#has ec0-30
#test model; no cv
ec30_rf_top <- ranger(y = log(train2$ec_ptf.030_100_cm +0.1), x = train2[idx], 
                    quantreg = TRUE, importance = "permutation",
                    respect.unordered.factors = FALSE,
                    seed = 111 
                    )

r2_ec30_top <- ec30_rf_top$r.squared


#model with cross validation
##0-30cm##
idx <- which(names(train2) %in% fs_b_stats$ec_ptf.000_030_cm$variable[3:17])
ec0_rfcv <- train(log(ec_ptf.000_030_cm +0.1) ~ ., data = train2[idx], 
               method = "ranger", quantreg = TRUE,
               na.action = na.exclude, importance = "permutation",
               trControl = trainControl(method = "cv", number = 10, repeats = 3, returnResamp = "all", savePredictions = TRUE, search = "random", verboseIter = FALSE)
               )

##30-100cm##
idx <- which(names(train2) %in% fs_b_stats$ec_ptf.030_100_cm$variable[2:18])#has ec0-30
ec30_rfcv <- train(log(ec_ptf.030_100_cm +0.1) ~ ., data = train2, 
               method = "ranger", quantreg = TRUE,
               na.action = na.exclude, importance = "permutation",
               trControl = trainControl(method = "cv", number = 10, repeats = 3, returnResamp = "all", savePredictions = TRUE, search = "random", verboseIter = FALSE)
               )

```



# SSURGO accuracy

```{r}

# SSURGO vs KSSL at 1000-meters
caret::R2(data$ph_000030, data$ph_saturated_paste.000_030_cm, na.rm = TRUE)
caret::R2(data$ec_000_030_cm, data$gnatsgo_ec_000030, na.rm = TRUE)

```

